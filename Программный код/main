#include <Servo.h>
#define MOTOR_L1  2
#define MOTOR_L2  3
#define ENA       4     // PWM левый
#define MOTOR_R1  5
#define MOTOR_R2  6
#define ENB       7     // PWM правый

Servo gripLeft;
Servo gripRight;
#define SERVO_L_PIN 8
#define SERVO_R_PIN 9

// Sonar
#define TRIG_PIN 10
#define ECHO_PIN 11

// Color Sensor 1 — ЦИЛИНДР
#define CS1_S0 22
#define CS1_S1 23
#define CS1_S2 24
#define CS1_S3 25
#define CS1_OUT 26

// Color Sensor 2 — ОТВЕРСТИЕ (смотрит вниз)
#define CS2_S0 28
#define CS2_S1 29
#define CS2_S2 30
#define CS2_S3 31
#define CS2_OUT 32
String currentCylinderColor = "";   // цвет захваченного цилиндра
bool hasCylinder = false;

void setup() {
  Serial.begin(9600);

  // Моторы
  pinMode(MOTOR_L1, OUTPUT); pinMode(MOTOR_L2, OUTPUT); pinMode(ENA, OUTPUT);
  pinMode(MOTOR_R1, OUTPUT); pinMode(MOTOR_R2, OUTPUT); pinMode(ENB, OUTPUT);

  // Серво
  gripLeft.attach(SERVO_L_PIN);
  gripRight.attach(SERVO_R_PIN);
  openGripper();

  // Цветовые датчики
  setupColorSensor(CS1_S0, CS1_S1, CS1_S2, CS1_S3);
  setupColorSensor(CS2_S0, CS2_S1, CS2_S2, CS2_S3);

  // Sonar
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  Serial.println("Робот готов к работе!");
  delay(1000);
}

void loop() {
  if (!hasCylinder) {
    searchAndPickCylinder();
  } else {
    searchAndDropCylinder();
  }
}

// ==================== ДВИЖЕНИЕ ====================
void moveForward(int speed = 180) {
  digitalWrite(MOTOR_L1, HIGH); digitalWrite(MOTOR_L2, LOW);
  digitalWrite(MOTOR_R1, HIGH); digitalWrite(MOTOR_R2, LOW);
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
}

void moveBackward(int speed = 150) {
  digitalWrite(MOTOR_L1, LOW); digitalWrite(MOTOR_L2, HIGH);
  digitalWrite(MOTOR_R1, LOW); digitalWrite(MOTOR_R2, HIGH);
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
}

void turnLeft(int speed = 160) {
  digitalWrite(MOTOR_L1, LOW);  digitalWrite(MOTOR_L2, HIGH);
  digitalWrite(MOTOR_R1, HIGH); digitalWrite(MOTOR_R2, LOW);
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
}

void turnRight(int speed = 160) {
  digitalWrite(MOTOR_L1, HIGH); digitalWrite(MOTOR_L2, LOW);
  digitalWrite(MOTOR_R1, LOW);  digitalWrite(MOTOR_R2, HIGH);
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
}

void stopMotors() {
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
}
void openGripper() {
  gripLeft.write(20);   // подбери углы под свою механику!
  gripRight.write(160);
  delay(400);
}

void closeGripper() {
  gripLeft.write(100);
  gripRight.write(80);
  delay(500);
}
long getDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  long duration = pulseIn(ECHO_PIN, HIGH);
  long distance = duration * 0.034 / 2;
  return distance;
}
void setupColorSensor(int s0, int s1, int s2, int s3) {
  pinMode(s0, OUTPUT); pinMode(s1, OUTPUT);
  pinMode(s2, OUTPUT); pinMode(s3, OUTPUT);
  digitalWrite(s0, HIGH);  // 100% масштаб частоты
  digitalWrite(s1, HIGH);
}

int readColorFrequency(int s2, int s3, int outPin) {
  digitalWrite(s2, LOW);
  digitalWrite(s3, LOW);   // Красный
  delay(10);
  return pulseIn(outPin, LOW);
}

String getColor(int sensor) {  // sensor = 1 или 2
  int s0, s1, s2, s3, outPin;
  if (sensor == 1) {
    s0 = CS1_S0; s1 = CS1_S1; s2 = CS1_S2; s3 = CS1_S3; outPin = CS1_OUT;
  } else {
    s0 = CS2_S0; s1 = CS2_S1; s2 = CS2_S2; s3 = CS2_S3; outPin = CS2_OUT;
  }

  // Читаем все три цвета
  digitalWrite(s2, LOW);  digitalWrite(s3, LOW);
  int red = pulseIn(outPin, LOW);

  digitalWrite(s2, HIGH); digitalWrite(s3, HIGH);
  int green = pulseIn(outPin, LOW);

  digitalWrite(s2, LOW);  digitalWrite(s3, HIGH);
  int blue = pulseIn(outPin, LOW);
  Serial.print("R:"); Serial.print(red);
  Serial.print(" G:"); Serial.print(white);
  Serial.print(" B:"); Serial.println(blue);

  if (red < 80 && red < green && red < blue) return "RED";
  if (green < 80 && green < red && green < blue) return "GREEN";
  if (blue < 90 && blue < red && blue < green) return "BLUE";

  return "UNKNOWN";
}

// ==================== ЛОГИКА РОБОТА ====================
void searchAndPickCylinder() {
  long dist = getDistance();

  if (dist < 14 && dist > 3) {           // нашли цилиндр
    stopMotors();
    delay(300);

    currentCylinderColor = getColor(1);  // читаем цвет цилиндра
    Serial.print("Обнаружен цилиндр цвета: ");
    Serial.println(currentCylinderColor);

    if (currentCylinderColor != "UNKNOWN") {
      closeGripper();
      hasCylinder = true;
      Serial.println("Цилиндр захвачен!");
      delay(800);
    } else {
      turnRight(140);
      delay(400);
    }
  } 
  else {
    moveForward(170);
    if (dist < 25) {
      stopMotors();
      turnLeft(160);
      delay(350);
    }
  }
void searchAndDropCylinder() {
  String holeColor = getColor(2);   // читаем цвет под собой

  if (holeColor == currentCylinderColor && holeColor != "UNKNOWN") {
    stopMotors();
    Serial.print("Найдено подходящее отверстие цвета ");
    Serial.println(holeColor);
    
    openGripper();          // сбрасываем цилиндр
    hasCylinder = false;
    currentCylinderColor = "";
    
    moveBackward(140); 
    delay(600);
    stopMotors();
    delay(400);
  } 
  else {
    moveForward(155);
    if (random(0, 100) < 25) {
      turnLeft(120);
      delay(120);
      stopMotors();
    }
  }
}
